# zmodload zsh/zprof



if [[ -f /etc/centos-release ]]; then
  if grep -q "CentOS Linux release 7" /etc/centos-release; then
    export LANG=en_US.UTF-8
  fi
fi


if ! command -v nix > /dev/null 2>&1; then
    if [ -e $HOME/.nix-profile/etc/profile.d/nix.sh ]; then . $HOME/.nix-profile/etc/profile.d/nix.sh; fi # added by Nix installer
fi



# If you come from bash you might have to change your $PATH.
export PATH=$HOME/bin:/usr/local/bin:$PATH

# ohmyzsh
export ZSH="$HOME/.oh-my-zsh"

function colemak_l() {
    zle beginning-of-line
    zvm_enter_insert_mode
}

zvm_after_lazy_keybindings() {
    zvm_define_widget colemak_l

    bindkey -M vicmd 'l' zvm_enter_insert_mode
    zvm_bindkey vicmd 'L' colemak_l
    bindkey -M vicmd 'n' down-line-or-history
    bindkey -M vicmd 'e' up-line-or-history
    bindkey -M vicmd 'i' vi-forward-char
}

# ZVM_VI_INSERT_ESCAPE_BINDKEY=,s

plugins=(
    asdf
    # git
    nvm
    # zsh-vi-mode
    # fzf-zsh-plugin
    zsh-autosuggestions
    # zsh-syntax-highlighting
    # fast-syntax-highlighting
    zsh-autocomplete
    forgit
    autoswitch_virtualenv
)
source $ZSH/oh-my-zsh.sh

# zsh-autocomplete settings
bindkey '^I' menu-select
bindkey "$terminfo[kcbt]" menu-select
bindkey -M menuselect '^I' menu-complete
bindkey -M menuselect "$terminfo[kcbt]" reverse-menu-complete

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
if command -v nvim >/dev/null 2>&1; then
    export EDITOR="nvim"
    export ZVM_VI_EDITOR="nvim"
fi

export CHEZ_EDITOR='chezmoi edit --watch'

export PATH="$HOME/.local/bin:$PATH"

# NIX
## https://nixos.wiki/wiki/Locales
## if not set, lazygit on ubuntu will complain about locale
export LOCALE_ARCHIVE=/usr/lib/locale/locale-archive

my_nix_install() {
    if [ -x "$(command -v nix-env)" ]; then
        packages=(
            "nvim:nixpkgs.neovim"
            "git:nixpkgs.git"
            "lsd:nixpkgs.lsd"
            "fd:nixpkgs.fd"
            "zoxide:nixpkgs.zoxide"
            "rg:nixpkgs.ripgrep"
            "dust:nixpkgs.dust"
            "bat:nixpkgs.bat"
            "fastfetch:nixpkgs.fastfetch"
            "gita:nixpkgs.gita"
            "broot:nixpkgs.broot"
            "delta:nixpkgs.delta"
            "lazygit:nixpkgs.lazygit"
            "hexyl:nixpkgs.hexyl"
            "btop:nixpkgs.btop"
            "procs:nixpkgs.procs"
            "diffstat:nixpkgs.diffstat"
            "fq:nixpkgs:fq"
        )


        for package in "${packages[@]}"; do
            cmd="${package%%:*}"
            nixpkg="${package##*:}"
            if ! [ -x "$(command -v $cmd)" ]; then
                nix-env -iA "$nixpkg"
            fi
        done

    else
        echo "my warning: nix not installed"
    fi
}

my-utils-install() {
  npm install xcv --global
}

# init setup

## neovim
export PATH="$PATH:/opt/nvim-linux64/bin"

## zoxide
eval "$(zoxide init zsh)"

## starship
eval "$(starship init zsh)"

# echo nvm
# ## nvm
# export NVM_DIR="$HOME/.nvm"
# [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"                   # This loads nvm
# [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion" # This loads nvm bash_completion
# echo nvm end
# zellij
if ! command -v zellij > /dev/null 2>&1; then
  echo "warning: zellij not installed"
fi
zellij_new_if_cannot_attach() {
  if [ -n "$TERM_PROGRAM" ] && [ "$TERM_PROGRAM" = "WezTerm" ]; then
    zellij attach -c my-wezterm

export MAKEFLAGS="-j$(nproc)"

# Set JAVA_HOME
export JAVA_HOME=$(dirname $(dirname $(dirname $(readlink -f $(/usr/bin/which java)))))
export PATH=$JAVA_HOME/bin:$PATH
  elif [ -n "$WT_SESSION" ]; then
    zellij attach -c my-winterm

## CUBRID necessary env vars
  elif [ -n "$TERM" ] && [ "$TERM" = "alacritty" ]; then
    zellij attach -c my-alacritty

# Check if the OS is CentOS 7 and source the devtoolset-8 script
if [[ -f /etc/centos-release ]]; then
  if grep -q "CentOS Linux release 7" /etc/centos-release; then
    source /opt/rh/devtoolset-8/enable
  else
    zellij a || zellij
  fi
}
alias za='zellij_new_if_cannot_attach'
alias zl='zellij_new_if_cannot_attach'
alias zell='zellij'

# Auto-run zellij if not on SSH
if [ -z "$SSH_CONNECTION" ] && [ "$TERM_PROGRAM" != "vscode" ]; then
  if ! command -v zellij &>/dev/null; then
    echo "zellij is not installed. Please install zellij to use this feature."
  else
    if [ -z "$ZELLIJ" ]; then
      zl
    fi
  fi
fi

# Enable fuzzy autocomplete
# e.g. ctda<tab> -> cu_trace_dump_all magic
# https://superuser.com/a/815317
# zellij_tab_name_update() {
#     if [[ -n $ZELLIJ ]]; then
#         local current_dir=$PWD
#         if [[ $current_dir == $HOME ]]; then
#             current_dir="~"
#         else
#             current_dir=${current_dir##*/}
#         fi
#         command nohup zellij action rename-tab "$current_dir" >/dev/null 2>&1
#     fi
# }
# 
# zellij_tab_name_update
# chpwd_functions+=(zellij_tab_name_update)


export LESS='-iRFSX'
export MANWIDTH=999

# direnv
eval "$(direnv hook zsh)"

clip() {
    if grep -qi microsoft /proc/version; then
        clip.exe "$@"
    else
        xclip -selection clipboard "$@"
    fi
}

export PATH=$PATH:/usr/local/go/bin

export PATH=$PATH:$HOME/go/bin

# ccache
# Check if 'ccache' exists and if '/usr/lib/ccache' directory exists
if command -v ccache > /dev/null 2>&1 && [ -d "/usr/lib/ccache/bin" ];then
  # arch linux
  export PATH="/usr/lib/ccache/bin:$PATH"
elif command -v ccache >/dev/null 2>&1 && [ -d "/usr/lib/ccache" ]; then
  # ubuntu
  export PATH="/usr/lib/ccache:$PATH"
fi

if command -v fastfetch > /dev/null 2>&1; then
    fastfetch
fi

# Check if the OS is Arch Linux
if [[ -f /etc/os-release && $(grep -oP '(?<=^ID=).+' /etc/os-release) == "arch" ]]; then
  export CC=gcc-13
  export CXX=g++-13
fi

alias zalias="$CHEZ_EDITOR $HOME/.config/vimkim-scripts/zsh/aliases.zsh"
alias zali='zalias'
source "$HOME/.config/vimkim-scripts/zsh/aliases.zsh"

# fzf configuration
if !command -v fzf >/dev/null 2>&1; then
  echo "Warning: fzf is not in your PATH"
fi

if [ -f ~/.fzf.zsh ]; then
    source ~/.fzf.zsh
else
    echo "Warning: ~/.fzf.zsh not found!"
fi

if [ -f ~/fzf-git.sh/fzf-git.sh ]; then
    source "$HOME/fzf-git.sh/fzf-git.sh"
else
    echo "Warning: ~/fzf-git.sh/fzf-git.sh not found!"
fi

if [ -n "${commands[fzf-share]}" ]; then
  source "$(fzf-share)/key-bindings.zsh"
  source "$(fzf-share)/completion.zsh"
else
  echo "Warning: fzf-share not found!"
fi



# zprof

